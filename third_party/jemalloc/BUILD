licenses(["notice"])

cc_library(
    name = "jemalloc",
    visibility = ["//visibility:public"],    
    includes = [
        "upstream/include",
        "k8/include",
    ],
    copts = [
        "-std=gnu11",
        "-fvisibility=hidden",
        "-funroll-loops",
        "-D_GNU_SOURCE",
        "-D_REENTRANT",
        "-DJEMALLOC_NO_PRIVATE_NAMESPACE",
    ],
    alwayslink = 1,
    hdrs = [
        "k8/include/jemalloc/internal/jemalloc_internal_defs.h",
        "k8/include/jemalloc/internal/jemalloc_preamble.h",
        "k8/include/jemalloc/internal/private_namespace.gen.h",
        "k8/include/jemalloc/internal/private_namespace.h",
        "k8/include/jemalloc/internal/public_namespace.h",
        "k8/include/jemalloc/internal/public_unnamespace.h",
        "k8/include/jemalloc/jemalloc.h",
        "k8/include/jemalloc/jemalloc_defs.h",
        "k8/include/jemalloc/jemalloc_macros.h",
        "k8/include/jemalloc/jemalloc_mangle.h",
        "k8/include/jemalloc/jemalloc_mangle_jet.h",
        "k8/include/jemalloc/jemalloc_protos.h",
        "k8/include/jemalloc/jemalloc_protos_jet.h",
        "k8/include/jemalloc/jemalloc_rename.h",
        "k8/include/jemalloc/jemalloc_typedefs.h",
        "upstream/include/jemalloc/internal/arena_externs.h",
        "upstream/include/jemalloc/internal/arena_inlines_a.h",
        "upstream/include/jemalloc/internal/arena_inlines_b.h",
        "upstream/include/jemalloc/internal/arena_stats.h",
        "upstream/include/jemalloc/internal/arena_structs_a.h",
        "upstream/include/jemalloc/internal/arena_structs_b.h",
        "upstream/include/jemalloc/internal/arena_types.h",
        "upstream/include/jemalloc/internal/assert.h",
        "upstream/include/jemalloc/internal/atomic.h",
        "upstream/include/jemalloc/internal/atomic_c11.h",
        "upstream/include/jemalloc/internal/atomic_gcc_atomic.h",
        "upstream/include/jemalloc/internal/atomic_gcc_sync.h",
        "upstream/include/jemalloc/internal/atomic_msvc.h",
        "upstream/include/jemalloc/internal/background_thread_externs.h",
        "upstream/include/jemalloc/internal/background_thread_inlines.h",
        "upstream/include/jemalloc/internal/background_thread_structs.h",
        "upstream/include/jemalloc/internal/base_externs.h",
        "upstream/include/jemalloc/internal/base_inlines.h",
        "upstream/include/jemalloc/internal/base_structs.h",
        "upstream/include/jemalloc/internal/base_types.h",
        "upstream/include/jemalloc/internal/bin.h",
        "upstream/include/jemalloc/internal/bin_stats.h",
        "upstream/include/jemalloc/internal/bin_types.h",
        "upstream/include/jemalloc/internal/bit_util.h",
        "upstream/include/jemalloc/internal/bitmap.h",
        "upstream/include/jemalloc/internal/cache_bin.h",
        "upstream/include/jemalloc/internal/ckh.h",
        "upstream/include/jemalloc/internal/ctl.h",
        "upstream/include/jemalloc/internal/div.h",
        "upstream/include/jemalloc/internal/emitter.h",
        "upstream/include/jemalloc/internal/extent_dss.h",
        "upstream/include/jemalloc/internal/extent_externs.h",
        "upstream/include/jemalloc/internal/extent_inlines.h",
        "upstream/include/jemalloc/internal/extent_mmap.h",
        "upstream/include/jemalloc/internal/extent_structs.h",
        "upstream/include/jemalloc/internal/extent_types.h",
        "upstream/include/jemalloc/internal/hash.h",
        "upstream/include/jemalloc/internal/hook.h",
        "upstream/include/jemalloc/internal/jemalloc_internal_decls.h",
        "upstream/include/jemalloc/internal/jemalloc_internal_externs.h",
        "upstream/include/jemalloc/internal/jemalloc_internal_includes.h",
        "upstream/include/jemalloc/internal/jemalloc_internal_inlines_a.h",
        "upstream/include/jemalloc/internal/jemalloc_internal_inlines_b.h",
        "upstream/include/jemalloc/internal/jemalloc_internal_inlines_c.h",
        "upstream/include/jemalloc/internal/jemalloc_internal_macros.h",
        "upstream/include/jemalloc/internal/jemalloc_internal_types.h",
        "upstream/include/jemalloc/internal/large_externs.h",
        "upstream/include/jemalloc/internal/log.h",
        "upstream/include/jemalloc/internal/malloc_io.h",
        "upstream/include/jemalloc/internal/mutex.h",
        "upstream/include/jemalloc/internal/mutex_pool.h",
        "upstream/include/jemalloc/internal/mutex_prof.h",
        "upstream/include/jemalloc/internal/nstime.h",
        "upstream/include/jemalloc/internal/pages.h",
        "upstream/include/jemalloc/internal/ph.h",
        "upstream/include/jemalloc/internal/prng.h",
        "upstream/include/jemalloc/internal/prof_externs.h",
        "upstream/include/jemalloc/internal/prof_inlines_a.h",
        "upstream/include/jemalloc/internal/prof_inlines_b.h",
        "upstream/include/jemalloc/internal/prof_structs.h",
        "upstream/include/jemalloc/internal/prof_types.h",
        "upstream/include/jemalloc/internal/ql.h",
        "upstream/include/jemalloc/internal/qr.h",
        "upstream/include/jemalloc/internal/quantum.h",
        "upstream/include/jemalloc/internal/rb.h",
        "upstream/include/jemalloc/internal/rtree.h",
        "upstream/include/jemalloc/internal/rtree_tsd.h",
        "upstream/include/jemalloc/internal/safety_check.h",
        "upstream/include/jemalloc/internal/sc.h",
        "upstream/include/jemalloc/internal/seq.h",
        "upstream/include/jemalloc/internal/smoothstep.h",
        "upstream/include/jemalloc/internal/spin.h",
        "upstream/include/jemalloc/internal/stats.h",
        "upstream/include/jemalloc/internal/sz.h",
        "upstream/include/jemalloc/internal/tcache_externs.h",
        "upstream/include/jemalloc/internal/tcache_inlines.h",
        "upstream/include/jemalloc/internal/tcache_structs.h",
        "upstream/include/jemalloc/internal/tcache_types.h",
        "upstream/include/jemalloc/internal/test_hooks.h",
        "upstream/include/jemalloc/internal/ticker.h",
        "upstream/include/jemalloc/internal/tsd.h",
        "upstream/include/jemalloc/internal/tsd_generic.h",
        "upstream/include/jemalloc/internal/tsd_malloc_thread_cleanup.h",
        "upstream/include/jemalloc/internal/tsd_tls.h",
        "upstream/include/jemalloc/internal/tsd_types.h",
        "upstream/include/jemalloc/internal/tsd_win.h",
        "upstream/include/jemalloc/internal/util.h",
        "upstream/include/jemalloc/internal/witness.h",
    ],
    srcs = [
        "upstream/src/jemalloc.c",
	"upstream/src/arena.c",
	"upstream/src/background_thread.c",
	"upstream/src/base.c",
	"upstream/src/bin.c",
	"upstream/src/bitmap.c",
	"upstream/src/ckh.c",
	"upstream/src/ctl.c",
	"upstream/src/div.c",
	"upstream/src/extent.c",
	"upstream/src/extent_dss.c",
	"upstream/src/extent_mmap.c",
	"upstream/src/hash.c",
	"upstream/src/hook.c",
	"upstream/src/large.c",
	"upstream/src/log.c",
	"upstream/src/malloc_io.c",
	"upstream/src/mutex.c",
	"upstream/src/mutex_pool.c",
	"upstream/src/nstime.c",
	"upstream/src/pages.c",
	"upstream/src/prng.c",
	"upstream/src/prof.c",
	"upstream/src/prof_data.c",
	"upstream/src/prof_log.c",
	"upstream/src/rtree.c",
	"upstream/src/safety_check.c",
	"upstream/src/stats.c",
	"upstream/src/sc.c",
	"upstream/src/sz.c",
	"upstream/src/tcache.c",
	"upstream/src/test_hooks.c",
	"upstream/src/ticker.c",
	"upstream/src/tsd.c",
	"upstream/src/witness.c",
    ],
    linkopts = [
        "-pthread",
        "-ldl",
    ],
    deps = [
        "//third_party/libunwind:libunwind-k8",
    ],
)

genrule(
    name = "gen_jeprof",
    srcs = [
        "upstream/bin/jeprof.in",
    ],
    outs = [
        "jeprof",
    ],
    cmd = "sed -e s/@jemalloc_version@/git-trunk/g $< > $@",
    executable = 1,
)

cc_library(
    name = "test_common",
    includes = [
        "upstream/test/include",
    ],
    hdrs = [
        "upstream/test/include/test/timer.h",
        "upstream/test/include/test/SFMT.h",
        "upstream/test/include/test/mtx.h",
        "upstream/test/include/test/SFMT-params.h",
        "upstream/test/include/test/extent_hooks.h",
        "upstream/test/include/test/SFMT-alti.h",
        "upstream/test/include/test/SFMT-params4253.h",
        "upstream/test/include/test/SFMT-params86243.h",
        "upstream/test/include/test/SFMT-params19937.h",
        "upstream/test/include/test/SFMT-sse2.h",
        "upstream/test/include/test/SFMT-params44497.h",
        "upstream/test/include/test/SFMT-params132049.h",
        "upstream/test/include/test/test.h",
        "upstream/test/include/test/thd.h",
        "upstream/test/include/test/SFMT-params1279.h",
        "upstream/test/include/test/SFMT-params11213.h",
        "upstream/test/include/test/jemalloc_test_defs.h",
        "upstream/test/include/test/jemalloc_test.h",
        "upstream/test/include/test/SFMT-params216091.h",
        "upstream/test/include/test/SFMT-params2281.h",
        "upstream/test/include/test/btalloc.h",
        "upstream/test/include/test/math.h",
        "upstream/test/include/test/SFMT-params607.h",
        "upstream/test/include/test/mq.h",
        # TODO: this is generated
        "upstream/include/jemalloc/internal/private_namespace_jet.h",
    ],
    srcs = [
        "upstream/test/src/test.c",
    ],
    deps = [
        ":jemalloc",
    ],
    defines = [
        "JEMALLOC_UNIT_TEST",
    ],
    testonly = 1,
)

# TODO: this doesn't build yet.
cc_test(
    name = "a0_test",
    srcs = [
        "upstream/test/unit/a0.c",
    ],
    deps = [
        ":test_common",
    ],
    malloc = ":jemalloc",
)

cc_test(
    name = "basic_cpp_test",
    srcs = [
        "upstream/test/integration/cpp/basic.cpp",
    ],
    deps = [
        ":test_common",
    ],
    copts = [
        "-DJEMALLOC_INTEGRATION_TEST",
        "-DJEMALLOC_INTEGRATION_CPP_TEST",
    ],
    malloc = ":jemalloc",
)
